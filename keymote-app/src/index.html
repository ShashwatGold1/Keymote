<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0d0d0f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Keymote">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>Keymote</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <!-- Processing Overlay (shown during QR scan/connection) -->
    <div id="processingOverlay" class="processing-overlay" style="display: none;">
        <div class="processing-content">
            <div class="processing-spinner"></div>
            <p id="processingText">Processing...</p>
        </div>
    </div>

    <!-- ============================================
         BROWSER BLOCKED SCREEN
         ============================================ -->
    <div id="browserBlockedScreen" class="browser-blocked-screen" style="display: none;">
        <div class="blocked-content">
            <div class="blocked-icon">üö´</div>
            <h1 class="blocked-title">App Required</h1>
            <p class="blocked-message">This application can only be used through the installed Keymote app.</p>
            <p class="blocked-hint">Please download and install the Keymote app to use this service.</p>
            <a href="https://play.google.com/store/apps/details?id=com.keymote.app" class="playstore-btn"
                target="_blank">
                <svg class="playstore-icon" viewBox="0 0 24 24" width="24" height="24">
                    <path fill="currentColor"
                        d="M3,20.5V3.5C3,2.91 3.34,2.39 3.84,2.15L13.69,12L3.84,21.85C3.34,21.6 3,21.09 3,20.5M16.81,15.12L6.05,21.34L14.54,12.85L16.81,15.12M20.16,10.81C20.5,11.08 20.75,11.5 20.75,12C20.75,12.5 20.53,12.9 20.18,13.18L17.89,14.5L15.39,12L17.89,9.5L20.16,10.81M6.05,2.66L16.81,8.88L14.54,11.15L6.05,2.66Z" />
                </svg>
                <span>Get it on Google Play</span>
            </a>
        </div>
    </div>

    <!-- ============================================
         SPLASH SCREEN - Animated Logo
         ============================================ -->
    <div id="splashScreen" class="splash-screen">
        <div class="splash-content">
            <div class="splash-logo">
                <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="2" y="6" width="20" height="12" rx="2" />
                    <circle cx="12" cy="12" r="2" />
                    <path d="M8 12h-2M18 12h-2" />
                </svg>
            </div>
            <h1 class="splash-title">Keymote</h1>
            <p class="splash-tagline">Remote Control Your PC</p>
            <div class="splash-loader"></div>
        </div>
    </div>

    <!-- ============================================
         LOGIN SCREEN - Authentication
         ============================================ -->
    <div id="loginScreen" class="login-screen" style="display: none;">
        <div class="login-content">
            <div class="login-header">
                <div class="login-logo">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="6" width="20" height="12" rx="2" />
                        <circle cx="12" cy="12" r="2" />
                        <path d="M8 12h-2M18 12h-2" />
                    </svg>
                </div>
                <h2 class="login-title">Connect to PC</h2>
            </div>

            <!-- QR Scanner Primary Action -->
            <div class="qr-scan-section">
                <div class="qr-buttons">
                    <button id="scanQrBtn" class="qr-scan-btn">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path
                                d="M3 7V5a2 2 0 0 1 2-2h2M17 3h2a2 2 0 0 1 2 2v2M21 17v2a2 2 0 0 1-2 2h-2M7 21H5a2 2 0 0 1-2-2v-2" />
                            <rect x="7" y="7" width="10" height="10" rx="1" />
                        </svg>
                        <span>Camera</span>
                    </button>
                    <button id="scanGalleryBtn" class="qr-scan-btn secondary">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                            <circle cx="8.5" cy="8.5" r="1.5" />
                            <polyline points="21 15 16 10 5 21" />
                        </svg>
                        <span>Gallery</span>
                    </button>
                    <button id="manualEntryBtn" class="qr-scan-btn secondary">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                        </svg>
                        <span>Manual</span>
                    </button>
                </div>
                <p class="qr-hint">Scan QR code or enter connection details manually</p>
            </div>

            <!-- Saved Devices List -->
            <div class="saved-connections" id="savedConnections">
                <div class="saved-title">Saved Devices</div>
                <div id="savedDevicesList" class="saved-list">
                    <!-- Saved devices will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Manual Connection Page (Full Screen) -->
    <div id="manualConnectionModal" class="manual-modal" style="display: none;">
        <div class="manual-header">
            <button id="closeManualBtn" class="back-btn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M15 18l-6-6 6-6" />
                </svg>
            </button>
            <span class="manual-title">Manual Connection</span>
        </div>

        <div class="manual-content">
            <div class="login-form full-page">
                <div class="login-field">
                    <label for="loginServerAddress">Server Address</label>
                    <input type="text" id="loginServerAddress" placeholder="e.g., 192.168.1.100:8765">
                </div>
                <div class="login-field">
                    <label for="loginComputerName">Computer Name</label>
                    <input type="text" id="loginComputerName" placeholder="e.g., DESKTOP-ABC">
                </div>
                <div class="login-field">
                    <label for="loginPin">PIN</label>
                    <input type="text" id="loginPin" placeholder="6-digit PIN" maxlength="6" pattern="[0-9]*"
                        inputmode="numeric">
                </div>

                <label class="login-checkbox">
                    <input type="checkbox" id="rememberMe" checked>
                    <span>Remember this device</span>
                </label>

                <label class="login-checkbox" style="margin-top: 8px;">
                    <input type="checkbox" id="internetMode">
                    <span>Connect via Internet (P2P)</span>
                </label>

                <button id="loginConnectBtn" class="login-btn">
                    <span class="btn-text">Connect</span>
                    <span class="btn-loader" style="display: none;"></span>
                </button>

                <div id="loginStatus" class="login-status"></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="app.js"></script>
    <!-- ============================================
         MAIN APP - Keyboard, Screen Share, etc.
         ============================================ -->
    <div class="app" id="mainApp" style="display: none;">
        <!-- Merged Header + Connection Status -->
        <header class="main-header">
            <div class="brand-logo">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="2" y="6" width="20" height="12" rx="2" />
                    <circle cx="12" cy="12" r="2" />
                    <path d="M8 12h-2M18 12h-2" />
                </svg>
                <span class="brand-name">Keymote</span>
            </div>
            <div class="header-buttons">
                <button id="settingsBtn" class="header-btn settings-btn">‚öôÔ∏è</button>
                <button id="themeBtn" class="header-btn theme-btn">üåô</button>
                <button id="connectionBtn" class="header-btn connection-btn">
                    <span class="conn-dot"></span>
                    <span id="latencyDisplay">--ms</span>
                </button>
            </div>
        </header>


        <!-- Text Input Section with Bottom-Right Corner Buttons -->
        <div class="input-section">
            <textarea id="inputArea" placeholder="Type here..." rows="2"></textarea>
            <div class="input-corner-btns">
                <button id="deleteAllBtn" class="corner-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path
                            d="M21 21H8a2 2 0 0 1-1.42-.587l-3.994-3.999a2 2 0 0 1 0-2.828l10-10a2 2 0 0 1 2.829 0l5.999 6a2 2 0 0 1 0 2.828L12.834 21" />
                        <path d="m5.082 11.09 8.828 8.828" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Screen Share Section (Collapsible) -->
        <div class="mouse-section">
            <div class="section-header">
                <span>üì∫ Screen Share</span>
                <button id="toggleMouse" class="toggle-btn">Show</button>
            </div>
            <div class="mouse-container" id="mouseContainer" style="display:none;">
                <!-- Screen Viewer / Trackpad -->
                <div class="screen-viewer" id="screenViewer">
                    <button id="exitFullscreenBtn" class="floating-back-btn" style="display:none;">‚úï Back</button>
                    <button id="fullscreenBtn" class="floating-max-btn">‚õ∂ Max</button>
                    <span class="corner-indicator corner-top">T</span>
                    <span class="corner-indicator corner-bottom">B</span>
                    <span class="corner-indicator corner-left">L</span>
                    <span class="corner-indicator corner-right">R</span>
                    <video id="remoteVideo" autoplay playsinline
                        style="display:none; width:100%; height:100%; object-fit:contain; background:black; pointer-events: none;"></video>
                    <!-- <img id="screenImage" class="screen-image" alt="Desktop Screen" style="display:none;"> -->
                    <div id="cursorIndicator" class="cursor-indicator" style="display:none; z-index: 100 !important;">
                    </div>
                    <div class="trackpad-overlay" id="trackpadOverlay">
                        <span class="trackpad-hint" id="trackpadHint">Drag to move ‚Ä¢ Tap to click</span>
                    </div>
                    <!-- Floating Toolbar (Fullscreen Mode) -->
                    <div id="floatingToolbar" class="floating-toolbar" style="display: none;">
                        <button id="fsScrollUp" class="toolbar-btn">‚ñ≤</button>
                        <button id="fsLeftClick" class="toolbar-btn">L</button>
                        <button id="fsRightClick" class="toolbar-btn">R</button>
                        <button id="fsScrollDown" class="toolbar-btn">‚ñº</button>
                        <button id="fsVoiceBtn" class="toolbar-btn voice-btn">‚å®</button>
                    </div>
                </div>
                <!-- Mouse Buttons: Left, Mid+Scroll, Right -->
                <div class="mouse-buttons">
                    <button id="leftClick" class="mouse-btn">Left</button>
                    <div class="mid-scroll-btn">
                        <button id="scrollUp" class="scroll-part">‚ñ≤</button>
                        <button id="middleClick" class="mid-part">Mid</button>
                        <button id="scrollDown" class="scroll-part">‚ñº</button>
                    </div>
                    <button id="rightClick" class="mouse-btn">Right</button>
                </div>
            </div>
        </div>

        <!-- Keyboard Section -->
        <div class="keyboard-section">
            <!-- Quick Shortcuts -->
            <div class="shortcuts">
                <button data-shortcut="ctrl+a">SelAll</button>
                <button data-shortcut="ctrl+c">Copy</button>
                <button data-shortcut="ctrl+v">Paste</button>
                <button data-shortcut="ctrl+x">Cut</button>
                <button data-shortcut="ctrl+z">Undo</button>
                <button data-shortcut="ctrl+s">Save</button>
                <button data-shortcut="ctrl+f">Find</button>
                <button data-shortcut="alt+f4">Quit</button>
            </div>

            <!-- Physical Keyboard Layout -->
            <div class="keyboard">
                <!-- Row 1: Function Keys (moved above numbers) -->
                <div class="row fn-row">
                    <button data-key="Escape" class="sm">Esc</button>
                    <button data-key="F1" class="fn">F1</button>
                    <button data-key="F2" class="fn">F2</button>
                    <button data-key="F3" class="fn">F3</button>
                    <button data-key="F4" class="fn">F4</button>
                    <button data-key="F5" class="fn">F5</button>
                    <button data-key="F6" class="fn">F6</button>
                    <button data-key="F7" class="fn">F7</button>
                    <button data-key="F8" class="fn">F8</button>
                    <button data-key="F9" class="fn">F9</button>
                    <button data-key="F10" class="fn">F10</button>
                    <button data-key="F11" class="fn">F11</button>
                    <button data-key="F12" class="fn">F12</button>
                </div>

                <!-- Row 2: Numbers with shift symbols -->
                <div class="row number-row">
                    <button data-key="`" data-shift="~" class="dual-key"><span class="shift-char">~</span><span
                            class="main-char">`</span></button>
                    <button data-key="1" data-shift="!" class="dual-key"><span class="shift-char">!</span><span
                            class="main-char">1</span></button>
                    <button data-key="2" data-shift="@" class="dual-key"><span class="shift-char">@</span><span
                            class="main-char">2</span></button>
                    <button data-key="3" data-shift="#" class="dual-key"><span class="shift-char">#</span><span
                            class="main-char">3</span></button>
                    <button data-key="4" data-shift="$" class="dual-key"><span class="shift-char">$</span><span
                            class="main-char">4</span></button>
                    <button data-key="5" data-shift="%" class="dual-key"><span class="shift-char">%</span><span
                            class="main-char">5</span></button>
                    <button data-key="6" data-shift="^" class="dual-key"><span class="shift-char">^</span><span
                            class="main-char">6</span></button>
                    <button data-key="7" data-shift="&" class="dual-key"><span class="shift-char">&amp;</span><span
                            class="main-char">7</span></button>
                    <button data-key="8" data-shift="*" class="dual-key"><span class="shift-char">*</span><span
                            class="main-char">8</span></button>
                    <button data-key="9" data-shift="(" class="dual-key"><span class="shift-char">(</span><span
                            class="main-char">9</span></button>
                    <button data-key="0" data-shift=")" class="dual-key"><span class="shift-char">)</span><span
                            class="main-char">0</span></button>
                    <button data-key="-" data-shift="_" class="dual-key"><span class="shift-char">_</span><span
                            class="main-char">-</span></button>
                    <button data-key="=" data-shift="+" class="dual-key"><span class="shift-char">+</span><span
                            class="main-char">=</span></button>
                    <button data-key="Backspace" class="wide">‚å´</button>
                </div>

                <!-- Row 3: QWERTY -->
                <div class="row">
                    <button data-key="Tab" class="med">Tab</button>
                    <button data-key="Q" class="k">Q</button>
                    <button data-key="W" class="k">W</button>
                    <button data-key="E" class="k">E</button>
                    <button data-key="R" class="k">R</button>
                    <button data-key="T" class="k">T</button>
                    <button data-key="Y" class="k">Y</button>
                    <button data-key="U" class="k">U</button>
                    <button data-key="I" class="k">I</button>
                    <button data-key="O" class="k">O</button>
                    <button data-key="P" class="k">P</button>
                    <button data-key="[" data-shift="{" class="dual-key"><span class="shift-char">{</span><span
                            class="main-char">[</span></button>
                    <button data-key="]" data-shift="}" class="dual-key"><span class="shift-char">}</span><span
                            class="main-char">]</span></button>
                    <button data-key="\" data-shift="|" class="dual-key"><span class="shift-char">|</span><span
                            class="main-char">\</span></button>
                </div>

                <!-- Row 4: ASDF -->
                <div class="row">
                    <button data-key="CapsLock" class="wide">Caps</button>
                    <button data-key="A" class="k">A</button>
                    <button data-key="S" class="k">S</button>
                    <button data-key="D" class="k">D</button>
                    <button data-key="F" class="k">F</button>
                    <button data-key="G" class="k">G</button>
                    <button data-key="H" class="k">H</button>
                    <button data-key="J" class="k">J</button>
                    <button data-key="K" class="k">K</button>
                    <button data-key="L" class="k">L</button>
                    <button data-key=";" data-shift=":" class="dual-key"><span class="shift-char">:</span><span
                            class="main-char">;</span></button>
                    <button data-key="'" data-shift='"' class="dual-key"><span class="shift-char">"</span><span
                            class="main-char">'</span></button>
                    <button data-key="Enter" class="wide">Enter</button>
                </div>

                <!-- Row 5: ZXCV -->
                <div class="row">
                    <button id="shiftKey" class="mod xl">Shift</button>
                    <button data-key="Z" class="k">Z</button>
                    <button data-key="X" class="k">X</button>
                    <button data-key="C" class="k">C</button>
                    <button data-key="V" class="k">V</button>
                    <button data-key="B" class="k">B</button>
                    <button data-key="N" class="k">N</button>
                    <button data-key="M" class="k">M</button>
                    <button data-key="," data-shift="<" class="dual-key"><span class="shift-char">&lt;</span><span
                            class="main-char">,</span></button>
                    <button data-key="." data-shift=">" class="dual-key"><span class="shift-char">&gt;</span><span
                            class="main-char">.</span></button>
                    <button data-key="/" data-shift="?" class="dual-key"><span class="shift-char">?</span><span
                            class="main-char">/</span></button>
                    <button data-key="ArrowUp" class="k">‚ñ≤</button>
                </div>

                <!-- Row 6: Bottom -->
                <div class="row">
                    <button id="ctrlKey" class="mod med">Ctrl</button>
                    <button id="winKey" class="mod sm">Win</button>
                    <button id="altKey" class="mod sm">Alt</button>
                    <button data-key="Space" class="space">Space</button>
                    <button data-key="ArrowLeft" class="k">‚óÄ</button>
                    <button data-key="ArrowDown" class="k">‚ñº</button>
                    <button data-key="ArrowRight" class="k">‚ñ∂</button>
                </div>
            </div>

            <!-- Media Keys -->
            <div class="media">
                <button data-key="VolumeMute">üîá</button>
                <button data-key="VolumeDown">üîâ</button>
                <button data-key="VolumeUp">üîä</button>
                <button data-key="MediaPrevTrack">‚èÆ</button>
                <button data-key="MediaPlayPause">‚èØ</button>
                <button data-key="MediaNextTrack">‚è≠</button>
            </div>
        </div>
    </div>

    <!-- ============================================
         SETTINGS SCREEN - Full Page Settings
         ============================================ -->
    <div id="settingsScreen" class="settings-screen" style="display: none;">
        <div class="settings-page-header">
            <button id="settingsBackBtn" class="settings-back-btn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7" />
                </svg>
            </button>
            <h2 class="settings-page-title">Settings</h2>
        </div>

        <div class="settings-page-content">
            <!-- Connection Section -->
            <div class="settings-section">
                <h3 class="settings-section-title">Connection</h3>
                <div class="settings-card">
                    <div class="settings-item">
                        <label for="serverAddress">Server Address</label>
                        <input type="text" id="serverAddress" placeholder="e.g., 192.168.1.100:8765">
                        <small>Leave empty for auto-detect</small>
                    </div>
                    <div class="settings-item">
                        <label for="computerNameInput">Computer Name</label>
                        <input type="text" id="computerNameInput" placeholder="e.g., DESKTOP-ABC">
                    </div>
                    <div class="settings-item">
                        <label for="pinInput">PIN</label>
                        <input type="text" id="pinInput" placeholder="6-digit PIN" maxlength="6" pattern="[0-9]*"
                            inputmode="numeric">
                    </div>
                    <button id="saveSettingsBtn" class="settings-connect-btn">Save & Connect</button>
                    <div id="authStatus" class="settings-status"></div>
                </div>
            </div>

            <!-- App Settings Section -->
            <div class="settings-section">
                <h3 class="settings-section-title">App Settings</h3>
                <div class="settings-card">
                    <div class="settings-item">
                        <label for="splashDurationInput">Splash Screen Duration</label>
                        <div class="slider-container">
                            <input type="range" id="splashDurationInput" min="0" max="10000" step="500" value="2500">
                            <span id="splashDurationValue">2.5s</span>
                        </div>
                        <small>0 to 10 seconds (auto-saves)</small>
                    </div>
                </div>
            </div>

            <!-- Screen Settings Section -->
            <div class="settings-section">
                <h3 class="settings-section-title">Screen Settings</h3>
                <div class="settings-card">
                    <div class="settings-item">
                        <label>X Offset (Left/Right)</label>
                        <div class="offset-control">
                            <button id="screenOffsetXMinus" class="offset-btn">‚àí</button>
                            <input type="range" id="screenOffsetX" min="-200" max="200" step="10" value="0">
                            <button id="screenOffsetXPlus" class="offset-btn">+</button>
                            <input type="number" id="screenOffsetXValue" class="offset-input" value="0">
                            <span>px</span>
                        </div>
                    </div>
                    <div class="settings-item">
                        <label>Y Offset (Up/Down)</label>
                        <div class="offset-control">
                            <button id="screenOffsetYMinus" class="offset-btn">‚àí</button>
                            <input type="range" id="screenOffsetY" min="-200" max="200" step="10" value="0">
                            <button id="screenOffsetYPlus" class="offset-btn">+</button>
                            <input type="number" id="screenOffsetYValue" class="offset-input" value="0">
                            <span>px</span>
                        </div>
                    </div>
                    <div class="settings-item">
                        <label>Zoom Level</label>
                        <div class="offset-control">
                            <input type="range" id="screenZoom" min="50" max="200" step="5" value="100">
                            <input type="number" id="screenZoomValue" class="offset-input" value="100">
                            <span>%</span>
                        </div>
                    </div>
                    <button id="resetScreenSettings" class="settings-reset-btn">Reset to Default</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Debug Modal -->
    <div id="debugModal" class="debug-modal" style="display: none;">
        <div class="debug-modal-content">
            <h3 id="debugModalTitle">Debug</h3>
            <pre id="debugModalMessage"></pre>
            <div class="debug-modal-buttons">
                <button id="debugCopyBtn" class="debug-copy-btn">üìã Copy</button>
                <button id="debugCloseBtn" class="debug-close-btn">Close</button>
            </div>
        </div>
    </div>

    <style>
        .debug-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 20px;
        }

        .debug-modal-content {
            background: #1a1a2e;
            border-radius: 12px;
            padding: 20px;
            max-width: 90%;
            max-height: 80%;
            overflow: auto;
        }

        .debug-modal-content h3 {
            color: #fff;
            margin: 0 0 15px 0;
        }

        .debug-modal-content pre {
            background: #0d0d15;
            color: #4ade80;
            padding: 15px;
            border-radius: 8px;
            white-space: pre-wrap;
            word-break: break-all;
            font-size: 12px;
            max-height: 300px;
            overflow: auto;
        }

        .debug-modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .debug-copy-btn {
            flex: 1;
            padding: 12px;
            background: #6366f1;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }

        .debug-close-btn {
            flex: 1;
            padding: 12px;
            background: #333;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>

    <script src="jsQR.js"></script>
    <script src="app.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(e => console.log('SW error:', e));
        }
    </script>
</body>

</html>